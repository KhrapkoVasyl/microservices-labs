# LAB 3-4 Architecture

## CQRS + Event Sourcing

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                                    LAB 3-4 ARCHITECTURE                                 │
│                                  CQRS + Event Sourcing                                  │
└─────────────────────────────────────────────────────────────────────────────────────────┘

                                         ┌─────────┐
                                         │  👤     │
                                         │ Client  │
                                         └────┬────┘
                                              │
              ════════════════════════════════╪════════════════════════════════
                                   HTTP (синхронні виклики)
              ════════════════════════════════╪════════════════════════════════
                                              │
                        ┌─────────────────────┴─────────────────────┐
                        │                                           │
                        ▼                                           ▼
              POST /compute                              GET /compute/tasks
                        │                                           │
                        ▼                                           ▼
         ┌──────────────────────────┐              ┌──────────────────────────┐
         │    COMMAND-SERVICE       │              │     QUERY-SERVICE        │
         │        :8000             │              │        :8001             │
         └────────────┬─────────────┘              └─────────────┬────────────┘
                      │                                          │
                      │                                          │ read
                      │                                          ▼
                      │                              ┌─────────────────────────┐
                      │                              │        MONGODB          │
                      │                              │        :27017           │
                      │                              │   (Materialized View)   │
                      │                              └─────────────▲───────────┘
                      │                                            │
              ════════╪════════════════════════════════════════════╪═══════════
                      │     KAFKA (асинхронні події)               │
              ════════╪════════════════════════════════════════════╪═══════════
                      │                                            │
                      │ publish                                    │ write
                      ▼                                            │
         ┌───────────────────────────────────────────────────────┐ │
         │                         KAFKA :9092                   │ │
         │                    Topic: compute-events              │ │
         │                                                       │ │
         │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐    │ │
         │  │TASK_CREATED │  │TASK_COMPLETED│  │ TASK_FAILED │   │ │
         │  └──────┬──────┘  └──────┬───────┘  └──────┬──────┘   │ │
         │         │                |                 |          │ │
         └─────────┼────────────────┼─────────────────┼──────────┘ │
                   │                │                 │            │
                   │ subscribe      │ publish         │ publish    │
                   ▼                |                 |            │
         ┌───────────────────────────────────────────────────────┐ │
         │                    COMPUTE-SERVICE (3 replicas)       │ │
         │                                                       │ │
         │   🔔 Тригериться по події TASK_CREATED                │ │
         │   📤 Публікує TASK_COMPLETED / TASK_FAILED ──▶ Kafka  │ │
         └───────────────────────────────────────────────────────┘ │
                                              │                    │
                                              │ subscribe          │
                                              ▼                    │
         ┌───────────────────────────────────────────────────────┐ │
         │                    MATERIALIZER-SERVICE               │ │
         │                                                       │ │
         │   🔔 Тригериться по ВСІХ подіях з Kafka               ├─┘
         │   📝 Записує в MongoDB                                │
         └───────────────────────────────────────────────────────┘
```

## Сервіси

| Service                  | Port       | Опис                              |
| ------------------------ | ---------- | --------------------------------- |
| **command-service**      | 8000       | Приймає команди, публікує події   |
| **query-service**        | 8001       | Читає з materialized view         |
| **compute-service**      | -          | Обробники (x3), обробляють задачі |
| **materializer-service** | -          | Будує read model в MongoDB        |
| **kafka**                | 9092/29092 | Message broker                    |
| **kafka-ui**             | 8080       | Web UI для Kafka                  |
| **mongodb**              | 27017      | База даних                        |
| **zookeeper**            | 2181       | Координатор Kafka                 |
